<!DOCTYPE html>
<html>

<head>
    <title>websocket demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
        .row {
            margin: 1rem
        }
    </style>
</head>

<body>
    <div class='row'>发送方：
        <select id='sender'>
            <option value="Bob" selected>Bob</option>
            <option value="Alice">Alice</option>
            <option value="Jack">Jack</option>
        </select>
    </div>
    <div class='row'>接收方：
        <select id='receiver'>
            <option value="Bob">Bob</option>
            <option value="Alice" selected>Alice</option>
            <option value="Jack">Jack</option>
        </select>
    </div>
    <textarea id='msg' class='row' rows="10" cols="30"></textarea>
    <div class='row'>
        <button id='sendBtn'>发送</button>
    </div>
    <h3 class='row'>收到的消息:</h3>
    <div id='conversation' class='row'></div>
    <script>
        // 可以通过下拉框选择消息发送者和接收者，点击发送按钮后，
        // 通过http post请求告知服务端消息的发送者，接收者以及消息内容，
        // 然后服务端通过websocket向消息接收者推送消息。
        //  客户端与服务端建立url为ws://{host}/ws/:name的websocket连接，
        // 其中name为消息发送者，当发送者改变时，关闭上一条连接
        // ，建立新的连接，例如消息发送方从Bob变为Alice, 则关闭ws://{host}/ws/Bob, 
        // 建立ws://{host}/ws/Alice, 这样我们就区分开了客户端，方便之后进行单点推送。

        var sender = document.getElementById('sender');
        var receiver = document.getElementById('receiver');
        var conversation = document.getElementById('conversation');
        var sendBtn = document.getElementById('sendBtn');
        var socket = null;
        var createSocket = function () {
            if (socket) {
                socket.close();
            }
            // var url = 'ws://' + window.location.host + '/ws/' + sender.options[sender.selectedIndex].value;
            var url = 'ws://' + '127.0.0.1:3000' + '/ws/' + sender.options[sender.selectedIndex].value;
            socket = new WebSocket(url);
            socket.onopen = function () {
                console.log('connected to ' + url);
            }
            // message 事件会在 WebSocket 接收到新消息时被触发
            socket.onmessage = function (event) {
                console.log(event, 'event');
                var data = JSON.parse(event.data);
                conversation.innerHTML = conversation.innerHTML + data.from + ':' + data.content + '<br/>';
            }
            socket.onclose = function () {
                console.log('close connect to' + url);
            }
        };

        var sendMessage = function () {
            var msg = document.getElementById('msg').value;
            fetch('http://127.0.0.1:3000/rest/message', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify({
                    from: sender.options[sender.selectedIndex].value,
                    content: msg,
                    to: receiver.options[receiver.selectedIndex].value
                })
            }).then(res => {
                return res.json();
            }).then(data => {
                if (!data.succeed) {
                    alert(data.msg);
                }
            })
        };

        sender.onchange = function () {
            createSocket();
        }

        sendBtn.onclick = function () {
            sendMessage();
        }

        createSocket();
    </script>
</body>

</html>